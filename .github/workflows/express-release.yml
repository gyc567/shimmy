name: Express Release (Simplified)

on:
  push:
    tags:
      - 'v*-express'  # Use -express suffix for simplified releases
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.7.2)'
        required: true
        type: string

jobs:
  # Simplified 3-gate process for when you're confident
  express-release:
    name: "âš¡ Express Release - 3 Essential Gates"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: "âš¡ ESSENTIAL GATE 1/3: Build & Test"
        run: |
          echo "::group::Essential Gate 1: Build & Test"
          echo "ðŸ”¨ Building with all features..."
          cargo build --release --all-features
          
          echo "ðŸ§ª Running test suite..."
          cargo test --all-features
          
          echo "âœ… Build and tests completed"
          echo "::endgroup::"

      - name: "âš¡ ESSENTIAL GATE 2/3: Package Validation"
        run: |
          echo "::group::Essential Gate 2: Package"
          echo "ðŸ“¦ Validating package contents..."
          
          # Quick package validation
          cargo package --allow-dirty --list > package_contents.txt
          
          # Check for critical files
          if grep -q "templates.*docker.*Dockerfile" package_contents.txt; then
            echo "âœ… Templates included"
          else
            echo "âŒ Missing templates"
            exit 1
          fi
          
          # Check binary size
          size=$(stat -c%s target/release/shimmy 2>/dev/null || echo "0")
          max_size=$((20 * 1024 * 1024))
          if [ "$size" -gt "$max_size" ]; then
            echo "âŒ Binary too large: ${size} > ${max_size}"
            exit 1
          fi
          
          echo "âœ… Package validation completed"
          echo "::endgroup::"

      - name: "âš¡ ESSENTIAL GATE 3/3: Documentation"
        run: |
          echo "::group::Essential Gate 3: Documentation"
          echo "ðŸ“š Building documentation..."
          cargo doc --all-features --no-deps
          echo "âœ… Documentation completed"
          echo "::endgroup::"

      - name: "ðŸš€ EXPRESS RELEASE SUCCESS"
        run: |
          echo "::group::Express Release Complete"
          echo "âœ… ALL 3 ESSENTIAL GATES PASSED"
          echo "ðŸš€ Express release successful!"
          echo "âš¡ Completed in ~3 minutes vs ~10 minutes for full gates"
          echo "::endgroup::"

      # Create GitHub release
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## Express Release ${{ github.ref_name }}
            
            This release was created using the simplified express release process.
            
            âš¡ **Express Gates Passed:**
            - âœ… Build & Test (all features)
            - âœ… Package Validation (templates + size)
            - âœ… Documentation Build
            
            ðŸ“¦ **Installation:**
            ```bash
            cargo install shimmy
            ```
            
            ðŸ”§ **Features:**
            - Full shimmy functionality
            - All backends available
            - Production ready
            
            ---
            *Created with Express Release workflow*
          draft: false
          prerelease: false

      # Upload release artifacts
      - name: Upload Release Binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: target/release/shimmy
          asset_name: shimmy-linux-x86_64
          asset_content_type: application/octet-stream